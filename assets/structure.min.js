"use strict";

var _createClass = (function() {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];
            descriptor.enumerable = descriptor.enumerable || false;
            descriptor.configurable = true;
            if ("value" in descriptor) descriptor.writable = true;
            Object.defineProperty(target, descriptor.key, descriptor);
        }
    }
    return function(Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);
        if (staticProps) defineProperties(Constructor, staticProps);
        return Constructor;
    };
})();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var Structure = (function() {
    function Structure() {
        var _ref =
                arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
            _ref$wrapper = _ref.wrapper,
            wrapper = _ref$wrapper === undefined ? "body" : _ref$wrapper,
            _ref$structureDataUrl = _ref.structureDataUrl,
            structureDataUrl =
                _ref$structureDataUrl === undefined
                    ? "structure.json"
                    : _ref$structureDataUrl;

        _classCallCheck(this, Structure);

        this._parameters = { structureDataUrl: structureDataUrl };
        var _wrapperNode = (this._wrapperNode =
            wrapper instanceof HTMLElement
                ? wrapper
                : document.querySelector(wrapper));
        if (!_wrapperNode)
            throw new Error("Wrapper " + wrapper + " not accessible");
        return this._updateStructureData()
            .then(this._prepareWrapper.bind(this))
            .then(
                function() {
                    window.addEventListener("resize", Structure.updateActiveItemPathes);
                    return this._renderStructure(
                        false,
                        this._getParameter("renderRules", "_root", "showDepth")
                    );
                }.bind(this)
            )
            .catch(function(error) {
                console.error(error);
                return false;
            }).result;
    }

    _createClass(
        Structure,
        [
            {
                key: "_updateStructureData",
                value: function _updateStructureData() {
                    var url =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : this._parameters.structureDataUrl;

                    return fetch(url)
                        .then(function(response) {
                            return response.json();
                        })
                        .then(
                            function(response) {
                                if (!response || !response.structure)
                                    throw new Error("Structure data empty");
                                if (response.parameters)
                                    Object.assign(
                                        this._parameters,
                                        response.parameters,
                                        this._parameters
                                    );
                                return this._parseStructureData(response.structure);
                            }.bind(this)
                        );
                }
            },
            {
                key: "_parseStructureData",
                value: function _parseStructureData() {
                    var structure =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : {};

                    this._structure = structure;
                    this._structureItems = [];
                    this._structureItems.push({
                        id: 0,
                        type: "root",
                        level: -1,
                        submissive: this._structure
                    }); // TODO: change root level to 0 (zero)
                    this._parseItemData(this._structureItems[0]);
                    return true;
                }
            },
            {
                key: "_parseItemData",
                value: function _parseItemData(parentItem) {
                    // TODO: split function and add Structure roots

                    // let parentStructure = genParentStructure(parentItem.structureData);

                    if (parentItem.partners)
                        for (var i in parentItem.partners) {
                            var itemData = parentItem.partners[i];
                            itemData.parentItem = parentItem;
                            itemData.partner = true;
                            itemData.assistant = true;
                            parseItem.call(this, itemData);
                        }
                    if (parentItem.leftPartners)
                        for (var _i in parentItem.leftPartners) {
                            var _itemData = parentItem.leftPartners[_i];
                            _itemData.parentItem = parentItem;
                            _itemData.leftPartner = true;
                            _itemData.assistant = true;
                            parseItem.call(this, _itemData);
                        }
                    if (parentItem.assistants)
                        for (var _i2 in parentItem.assistants) {
                            var _itemData2 = parentItem.assistants[_i2];
                            _itemData2.parentItem = parentItem;
                            _itemData2.assistant = true;
                            parseItem.call(this, _itemData2);
                        }

                    var childLevel = parentItem.level + 1;

                    if (parentItem.submissive)
                        for (var _i3 in parentItem.submissive) {
                            var _itemData3 = parentItem.submissive[_i3];
                            _itemData3.parentItem = parentItem;
                            parseItem.call(this, _itemData3, childLevel);
                        }

                    function parseItem() {
                        var itemData =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};
                        var level =
                            arguments.length > 1 && arguments[1] !== undefined
                                ? arguments[1]
                                : false;

                        itemData.structureData = genParentStructure(itemData);
                        itemData.id = this._structureItems.length;
                        itemData.level =
                            typeof level === "number" ? level : itemData.parentItem.level;
                        // itemData.level = level ? level : itemData.parentItem.level;
                        this._structureItems[itemData.id] = itemData;
                        this._parseItemData(itemData);
                    }

                    function genParentStructure() {
                        var itemData =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};

                        var structureData = {};
                        if (itemData.parentItem.structureData)
                            Object.assign(
                                structureData,
                                structureData,
                                itemData.parentItem.structureData
                            );
                        if (itemData.parentItem.type === "department")
                            structureData.department = itemData.parentItem;
                        if (itemData.parentItem.type === "division")
                            structureData.division = itemData.parentItem;
                        return structureData;
                    }
                }
            },
            {
                key: "_prepareWrapper",
                value: function _prepareWrapper() {
                    // console.log('1: _prepareWrapper');
                    this._wrapperNode.classList.add("structure-wrapper");
                    Structure._pathesWrapperNode = this._pathesWrapperNode = document.createElement(
                        "div"
                    );
                    this._pathesWrapperNode.id = "path-wrapper";
                    this._wrapperNode.innerHTML = "";
                    this._wrapperNode.appendChild(this._pathesWrapperNode);
                    return true;
                }
            },
            {
                key: "_renderStructure",
                value: function _renderStructure() {
                    var parentId =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : false;
                    var depth =
                        arguments.length > 1 && arguments[1] !== undefined
                            ? arguments[1]
                            : 0;

                    // console.log('2: _renderStructure');
                    var item = this._getItemById(parentId);
                    var childLevel = item.level + 1;
                    // if (this._parameters && this._parameters.renderRules && this._parameters.renderRules[item.type] && this._parameters.renderRules[item.type].showDepth)
                    var depthRule = this._getParameter(
                        "renderRules",
                        item.type,
                        "showDepth"
                    );
                    if (depthRule) depth = depthRule;
                    var destroyLevelId = childLevel + depth;
                    for (var i = childLevel; i <= childLevel + depth; i++) {
                        destroyLevelId = i + 1;
                        var level =
                            !this._level || !this._level[i]
                                ? this._renderLevel(i)
                                : this._level[i];
                        // level.node.innerHTML = '';
                        this._cleanLevel(level.id);
                        if (!item.submissive || item.submissive.length === 0) break;
                        this._setActiveItem(item.id);
                        level.items = item.submissive;
                        this._renderItems(level.items, i);
                        if (level.items.length === 1) {
                            if (level.items[0].role === "head") {
                                if (
                                    level.items[0].partners ||
                                    level.items[0].leftPartners ||
                                    level.items[0].assistants
                                ) {
                                    level.node.classList.add("disable-right-space");
                                } else {
                                    level.node.classList.add("center-items");
                                }
                            } else {
                                level.node.classList.add("center-items");
                                // let rightSpace = level.node.appendChild(document.createElement('div'));
                                // rightSpace.classList.add('right-space');
                            }
                        } else {
                            var rightSpace = level.node.appendChild(
                                document.createElement("div")
                            );
                            rightSpace.classList.add("right-space");
                        }

                        /*let rightSpace = level.node.appendChild(document.createElement('div'));
                            rightSpace.classList.add('right-space');*/
                        this._createActiveItemPath(item.id);
                        if (
                            item.type === "department" &&
                            level.items.length > 0 &&
                            level.items[0].type === "division"
                        )
                            break;
                        item = level.items[0];
                    }
                    this._destroyStructure(destroyLevelId);
                }
            },
            {
                key: "_renderLevel",
                value: function _renderLevel() {
                    var level =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : false;

                    if (!this._level) this._level = {};
                    if (typeof level !== "number" || isNaN((level = parseInt(level))))
                        throw new Error("Level " + arguments[0] + " is incorrect");
                    var targetLevel = (this._level[level] = {
                        id: level,
                        node: document.createElement("section"),
                        items: []
                    });

                    var levelWrapperNode = document.createElement("div");
                    levelWrapperNode.classList.add("level-wrapper");

                    targetLevel.node.addEventListener(
                        "scroll",
                        Structure.updateActiveItemPathes
                    );

                    targetLevel.leftButton = document.createElement("button");
                    targetLevel.leftButton.classList.add("structure-scroll-left");
                    targetLevel.leftButton.addEventListener("click", function(event) {
                        var scrollSection = this.parentNode.querySelector("section");
                        var scroll = scrollSection.scrollLeft - 340;
                        scrollSection.scroll(scroll, false);
                    });
                    levelWrapperNode.appendChild(targetLevel.leftButton);

                    levelWrapperNode.appendChild(targetLevel.node);

                    targetLevel.rightButton = document.createElement("button");
                    targetLevel.rightButton.classList.add("structure-scroll-right");
                    targetLevel.rightButton.addEventListener("click", function(event) {
                        var scrollSection = this.parentNode.querySelector("section");
                        var scroll = scrollSection.scrollLeft + 340;
                        scrollSection.scroll(scroll, false);
                    });
                    levelWrapperNode.appendChild(targetLevel.rightButton);

                    targetLevel.node.dataset.structureLevel = level;

                    this._wrapperNode.appendChild(levelWrapperNode);
                    return targetLevel;
                }
            },
            {
                key: "_cleanLevel",
                value: function _cleanLevel() {
                    var level =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : false;

                    this._level[level].node.scrollTo(0, 0);
                    this._level[level].node
                        .querySelectorAll(".item")
                        .forEach(function(item) {
                            item.parentNode.removeChild(item);
                        });
                    this._level[level].node
                        .querySelectorAll(".right-space")
                        .forEach(function(item) {
                            item.parentNode.removeChild(item);
                        });
                    this._level[level].node.className = "";
                    Structure._removeActiveItemPath(level);
                }
            },
            {
                key: "_getItemById",
                value: function _getItemById() {
                    var id =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : false;

                    if (!id)
                        return {
                            id: false,
                            level: -1,
                            submissive: this._structure
                        };
                    else if (!this._structureItems || !this._structureItems[id])
                        throw new Error("Item with ID: " + id + " not exist");
                    else return this._structureItems[id];
                }
            },
            {
                key: "_renderItems",
                value: function _renderItems() {
                    var items =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : [];
                    var level =
                        arguments.length > 1 && arguments[1] !== undefined
                            ? arguments[1]
                            : false;

                    var positionsLevel = true;
                    for (var i in items) {
                        var item = items[i];
                        if (!level) level = item.level;
                        if (!item.role || item.role !== "position") positionsLevel = false;
                        var itemNode = this._renderItem(item, level);
                        if (item.partners && item.partners.length > 0)
                            for (var j in item.partners) {
                                var partner = item.partners[j];
                                partner.order = j;
                                this._renderItem(partner, level);
                            }
                        if (item.leftPartners && item.leftPartners.length > 0)
                            for (var _j in item.leftPartners) {
                                var _partner = item.leftPartners[_j];
                                _partner.left = true;
                                // partner.order = j;
                                this._renderItem(_partner, level);
                            }
                        if (item.assistants && item.assistants.length > 0) {
                            this._level[level].node.classList.add("extended-level");
                            for (var _j2 in item.assistants) {
                                var assistant = item.assistants[_j2];
                                assistant.subLevel = true;
                                assistant.order = _j2;
                                this._renderItem(assistant, level);
                            }
                        }
                        if (
                            this._level[level].node.classList.contains("extended-level") &&
                            !itemNode.classList.contains("sub-level")
                        ) {
                            var styleElem = itemNode.appendChild(
                                document.createElement("style")
                            );
                            var itemPathWidth = 0;
                            var prevItem = itemNode;
                            while ((prevItem = prevItem.previousSibling)) {
                                itemPathWidth = itemNode.offsetLeft - prevItem.offsetLeft;
                            }
                            if (itemPathWidth <= 0) itemPathWidth = 1;
                            styleElem.innerHTML =
                                '.structure-wrapper section.extended-level > .item[data-structure-item="' +
                                item.id +
                                '"]:not(.active-child):not(.active):before {width: ' +
                                itemPathWidth +
                                "px;left: calc(-" +
                                itemPathWidth +
                                "px + 50%);";
                        }
                    }
                    if (positionsLevel)
                        this._level[level].node.classList.add("active-positions");
                }
            },
            {
                key: "_renderItem",
                value: function _renderItem() {
                    var item =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : {};
                    var level =
                        arguments.length > 1 && arguments[1] !== undefined
                            ? arguments[1]
                            : false;

                    if (level === false) level = item.level;
                    if (!this._level[level])
                        throw new Error("Level " + level + " is not available");
                    var itemNode = document.createElement("div");
                    itemNode.dataset.structureItem = item.id;
                    itemNode.classList.add("item");
                    if (item.type) itemNode.classList.add(item.type);
                    if (item.role) itemNode.classList.add(item.role);
                    if (
                        (item.partners && item.partners.length > 0) ||
                        (item.assistants && item.assistants.length > 0)
                    )
                        itemNode.classList.add("partner");
                    if (item.subLevel) itemNode.classList.add("sub-level");

                    if (parseInt(item.order) === 0)
                        itemNode.classList.add("first-after-head");
                    if (item.left) itemNode.classList.add("left");
                    // if (item.title) itemNode.innerHTML += `<div class="title">${item.title}</div>`;
                    // if (item.description) itemNode.innerHTML += `<div class="description">${item.description}</div>`;
                    if (item.roleTitle)
                        itemNode.innerHTML +=
                            '<div class="title">' +
                            item.roleTitle +
                            '</div><div class="description">' +
                            item.name +
                            "</div>";
                    else
                        itemNode.innerHTML += '<div class="title">' + item.name + "</div>";
                    var self = this;
                    if (item.submissive && item.submissive.length > 0) {
                        itemNode.style.cursor = "pointer";
                        itemNode.innerHTML += '<div class="state-button"></div>';

                        itemNode.addEventListener("click", function(event) {
                            if (!this.dataset.structureItem) return false;
                            var id = this.dataset.structureItem;
                            if (this.classList.contains("active")) {
                                var _level = parseInt(this.parentNode.dataset.structureLevel);
                                self._unsetActiveItems(_level);
                                Structure._removeActiveItemPath(_level);
                                self._destroyStructure(_level + 1);
                            } else {
                                self._setActiveItem(id);
                                self._renderStructure(id);
                                self._createActiveItemPath(id);
                            }
                            Structure.updateActiveItemPathes();
                        });
                    }
                    var itemModal = document.createElement("div");
                    itemModal.classList.add("modal-link");
                    itemModal.addEventListener("click", function(event) {
                        event.stopPropagation();
                        if (!this.parentNode.dataset.structureItem) return false;
                        var id = this.parentNode.dataset.structureItem;
                        self._showItemModal(id);
                    });
                    itemNode.appendChild(itemModal);
                    if (item.left) {
                        var parentItemNode = document.querySelector(
                            '[data-structure-item="' + item.parentItem.id + '"]'
                        );
                        parentItemNode.parentNode.insertBefore(itemNode, parentItemNode);
                    } else this._level[level].node.appendChild(itemNode);
                    return itemNode;
                }
            },
            {
                key: "_setActiveItem",
                value: function _setActiveItem() {
                    var id =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : false;

                    var item = this._getItemById(id);
                    this._unsetActiveItems(item.level);
                    var itemNode = document.querySelector(
                        '[data-structure-item="' + id + '"]'
                    );
                    if (!itemNode) return;
                    itemNode.classList.add("active");
                    if (itemNode.classList.contains("assistant")) {
                        var iterateNode = itemNode;
                        var parentNode = false;
                        while ((iterateNode = iterateNode.previousElementSibling)) {
                            if (!iterateNode.classList.contains("assistant")) {
                                parentNode = iterateNode;
                                break;
                            }
                        }
                        if (parentNode) parentNode.classList.add("active-child");
                    }
                }
            },
            {
                key: "_unsetActiveItems",
                value: function _unsetActiveItems(level) {
                    var levelNode = document.querySelector(
                        '[data-structure-level="' + level + '"]'
                    );
                    if (!levelNode) return;
                    levelNode
                        .querySelectorAll("[data-structure-item]")
                        .forEach(this._unsetActiveItem);
                }
            },
            {
                key: "_unsetActiveItem",
                value: function _unsetActiveItem(element) {
                    element.classList.remove("active");
                    element.classList.remove("active-child");
                }
            },
            {
                key: "_destroyStructure",
                value: function _destroyStructure() {
                    var level =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : 0;

                    var maxLevel = Object.values(this._level).length - 1;
                    for (var i = maxLevel; i >= level; i--) {
                        Structure._removeActiveItemPath(i);
                        if (!this._level[i]) continue;
                        var levelData = this._level[i];
                        var levelWrapper = levelData.node.parentNode;
                        levelWrapper.parentNode.removeChild(levelWrapper);
                        delete this._level[i];
                    }
                }
            },
            {
                key: "_createActiveItemPath",
                value: function _createActiveItemPath(id) {
                    var item = this._getItemById(id);
                    var itemNode = document.querySelector(
                        '[data-structure-item="' + id + '"]'
                    );
                    if (!itemNode) return;
                    var pathId = item.level;
                    Structure._removeActiveItemPath(pathId);
                    var path = document.createElement("div");
                    path.classList.add("active-path");
                    path.dataset.structurePath = pathId;
                    path.dataset.structurePathParentItem = item.id;
                    var levelNode = document.querySelector(
                        '[data-structure-level="' + pathId + '"]'
                    );
                    var parentLevelNode = document.querySelector(
                        '[data-structure-level="' + (pathId - 1) + '"]'
                    );
                    if (levelNode) {
                        levelNode.dataset.pathScrollEvent = pathId;
                        //levelNode.addEventListener('scroll', Structure.updateActiveItemPathes);
                    }
                    if (parentLevelNode) {
                        parentLevelNode.dataset.pathScrollEvent = pathId;
                        //parentLevelNode.addEventListener('scroll', Structure.updateActiveItemPathes);
                    }
                    this._pathesWrapperNode.appendChild(path);
                    // Structure.calculatePathPositionHandler.call(path);
                    Structure.updateActiveItemPathes(); //.call(path);
                }
            },
            {
                key: "_createActiveSubItemPath",
                value: function _createActiveSubItemPath(id) {
                    var item = this._getItemById(id);
                    var itemNode = document.querySelector(
                        '[data-structure-item="' + id + '"]'
                    );
                    if (!itemNode) return;
                    var pathId = item.level;
                    this._removeActiveSubItemPath(pathId);
                    var path = document.createElement("div");
                    path.classList.add("active-path");
                    path.dataset.structureSubPath = pathId;
                    path.dataset.structureSubPathTargetItem = item.id;
                    var levelNode = document.querySelector(
                        '[data-structure-level="' + pathId + '"]'
                    );
                    // let parentLevelNode = document.querySelector(`[data-structure-level="${pathId - 1}"]`);
                    if (levelNode) {
                        levelNode.dataset.subPathScrollEvent = pathId;
                        levelNode.addEventListener(
                            "scroll",
                            Structure.updateActiveItemPathes
                        );
                    }
                    this._pathesWrapperNode.appendChild(path);
                    // Structure.calculatePathPositionHandler.call(path);
                    Structure.updateActiveItemPathes(); //.call(path);
                }
            },
            {
                key: "_removeActiveSubItemPath",
                value: function _removeActiveSubItemPath(level) {
                    this._pathesWrapperNode
                        .querySelectorAll('[data-structure-sub-path="' + level + '"]')
                        .forEach(function(pathNode) {
                            pathNode.parentNode.removeChild(pathNode);
                        });
                }
            },
            {
                key: "_getParameter",
                value: function _getParameter() {
                    var parentParameter = this._parameters;

                    for (
                        var _len = arguments.length, path = Array(_len), _key = 0;
                        _key < _len;
                        _key++
                    ) {
                        path[_key] = arguments[_key];
                    }

                    while (parentParameter[path[0]]) {
                        if (path.length === 1) return parentParameter[path[0]];
                        parentParameter = parentParameter[path[0]];
                        path.shift();
                    }
                    return false;
                }
            },
            {
                key: "_showItemModal",
                value: function _showItemModal() {
                    var id =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : false;

                    document
                        .querySelectorAll("[data-structure-modal]")
                        .forEach(function(modal) {
                            modal.parentNode.removeChild(modal);
                        });
                    if (!id) throw new Error("Empty item ID");
                    var item = this._getItemById(id);
                    var modal = document.createElement("modal");
                    modal.addEventListener("click", Structure.closeModals);
                    modal.classList.add("structure-modal-wrapper");
                    modal.dataset.structureModal = id;
                    modal.innerHTML = this._genModalContent(item);
                    modal
                        .querySelector(".structure-modal-content")
                        .addEventListener("click", function(e) {
                            return e.stopPropagation();
                        });
                    modal
                        .querySelectorAll("[data-structure-modal-link]")
                        .forEach(this._prepareItemModalLink, this);
                    document.body.appendChild(modal);
                    // return this._loadModalData(id);
                }
            },
            {
                key: "_prepareItemModalLink",
                value: function _prepareItemModalLink(link) {
                    var self = this;
                    link.addEventListener("click", function(event) {
                        self._showItemModal(this.dataset.structureModalLink);
                    });
                }
            },
            {
                key: "_loadModalData",
                value: function _loadModalData() {
                    var id =
                        arguments.length > 0 && arguments[0] !== undefined
                            ? arguments[0]
                            : false;

                    var item = this._getItemById(id);
                    var data = {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            type: item.type,
                            id: item.id
                        })
                    };
                    return fetch(this._parameters.modalDataUrl, data)
                        .then(function(response) {
                            return response.json();
                        })
                        .then(
                            function(response) {
                                if (!response || !response.data)
                                    throw new Error("Modal data empty");
                                var modal = document.querySelector(
                                    '[data-structure-modal="' + item.id + '"]'
                                );
                                if (!modal) return;
                                Object.assign(response.data, item, response.data);
                                modal.innerHTML = this._genModalContent(response.data);
                            }.bind(this)
                        );
                }
            },
            {
                key: "_genModalContent",
                value: function _genModalContent(item) {
                    if (!item.type) throw new Error("Incorrect item type");

                    var source =
                        '<div class="structure-modal-content">' +
                        genHeader(item) +
                        '<div class="modal-body">';

                    switch (item.type) {
                        case "profile":
                            if (item.roleTitle)
                                source += '<h2 class="title">' + item.roleTitle + "</h2>";
                            if (item.structureData.division)
                                source +=
                                    '<a class="structure-link" data-structure-modal-link="' +
                                    item.structureData.division.id +
                                    '">' +
                                    item.structureData.division.name +
                                    "</a><br><br>";
                            if (item.structureData.department)
                                source +=
                                    '<a class="structure-link" data-structure-modal-link="' +
                                    item.structureData.department.id +
                                    '">' +
                                    item.structureData.department.name +
                                    "</a>";
                            /*if (item.role === 'headOfDepartment' || item.role === 'headOfDivision') {
                                      let structure = item.parentItem;
                                      source += `<a class="structure-link" data-structure-modal-link="${structure.id}">${structure.name}</a>`;
                                  }*/
                            source +=
                                '<hr><div class="sub-title">\u041E\u0441\u043D\u043E\u0432\u043D\u0430\u044F \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F</div>';
                            if (item.partners && item.partners.length > 0) {
                                source +=
                                    '<div class="info-line"><strong>\u0410\u0441\u0438\u0441\u0442\u0435\u043D\u0442: </strong>' +
                                    item.partners[0].name +
                                    "</div>";
                            }
                            source += genProfileContacts.call(this, item);
                            break;
                        case "department":
                            source += genStructureManagement.call(
                                this,
                                item,
                                "headOfDepartment"
                            );
                            if (item.submissive && item.submissive[0]) {
                                var structure =
                                    item.submissive[0].role === "headOfDepartment"
                                        ? item.submissive[0]
                                        : item;
                                source +=
                                    '<hr><div class="sub-title">\u041F\u043E\u0434\u0440\u0430\u0437\u0434\u0435\u043B\u0435\u043D\u0438\u044F</div><div class="department-structure">' +
                                    genDepartmentStructure(structure, "division") +
                                    "</div>";
                            }
                            break;
                        case "division":
                            source += genStructureManagement.call(
                                this,
                                item,
                                "headOfDivision"
                            );
                            if (item.submissive && item.submissive[0]) {
                                var _structure =
                                    item.submissive[0].role === "headOfDivision"
                                        ? item.submissive[0]
                                        : item;
                                source +=
                                    '<hr><div class="sub-title">\u0421\u043E\u0442\u0440\u0443\u0434\u043D\u0438\u043A\u0438 \u043E\u0442\u0434\u0435\u043B\u0430</div><div class="division-structure">' +
                                    genDivisionStructure(_structure, "profile") +
                                    "</div>";
                            }
                            break;
                        default:
                            source += "Unsupported type";
                            break;
                    }

                    source +=
                        '</div><button class="structure-modal-close" onclick="Structure.closeModals();">\xD7</button></div>';

                    function genHeader() {
                        var item =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};

                        var source = "";
                        if (!item) return source;
                        source +=
                            '<div class="modal-header" ' +
                            (item.cover
                                ? "style=\"background-image: url('" + item.cover + "');\""
                                : "") +
                            ">";
                        if (item.image)
                            source +=
                                '<div class="image"><img src="' + item.image + '"></div>';
                        else
                            source += '<div class="image"><img src="assets/logo.svg"></div>';
                        source += '<div class="right-section">';
                        if (item.name) source += '<h2 class="title">' + item.name + "</h2>";
                        if (item.birthday) {
                            var dateComponents = item.birthday.split("-").reverse();
                            var bithDate = new Date(
                                dateComponents[0],
                                dateComponents[1],
                                dateComponents[2]
                            ).toLocaleString("ru", {
                                month: "long",
                                day: "numeric"
                            });
                            source +=
                                '<div class="birthday">\u0414\u0430\u0442\u0430 \u0440\u043E\u0436\u0434\u0435\u043D\u0438\u044F: ' +
                                bithDate +
                                "</div>";
                        }
                        source += "</div></div>";
                        return source;
                    }

                    function genStructureManagement() {
                        var item =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};
                        var role =
                            arguments.length > 1 && arguments[1] !== undefined
                                ? arguments[1]
                                : false;

                        var source = "";
                        var parentRole = true;
                        if (item.submissive || item.submissive.length > 0) {
                            if (role) {
                                for (var i in item.submissive) {
                                    if (item.submissive[i].role === role) parentRole = false;
                                }
                            } else parentRole = false;
                            if (parentRole) {
                                source += genManager.call(this, item.parentItem);
                            } else
                                for (var _i4 in item.submissive) {
                                    source += genManager.call(this, item.submissive[_i4]);
                                }
                        }
                        return source;
                    }

                    function genManager() {
                        var manager =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};

                        source = "";
                        source += '<div class="manager-item">';
                        if (manager.image)
                            source +=
                                '<div class="image"><img src="' + manager.image + '"></div>';
                        else
                            source += '<div class="image"><img src="assets/logo.svg"></div>';
                        source += '<div class="info-section">';
                        if (manager.roleTitle)
                            source += '<div class="title">' + manager.roleTitle + "</div>";
                        if (manager.name)
                            source += '<div class="sub-title">' + manager.name + "</div>";
                        source += genProfileContacts.call(this, manager) + "</div></div>";
                        if (manager.partners && manager.partners.length > 0) {
                            for (var i in manager.partners) {
                                source += genManager.call(this, manager.partners[i]);
                            }
                        }
                        return source;
                    }

                    function genProfileContacts() {
                        var item =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};

                        var source = "";
                        var fieldParameters = this._getParameter("parseRules", item.type);
                        if (fieldParameters) {
                            var fieldIds = Object.keys(fieldParameters);
                            for (var i in fieldIds) {
                                var fieldId = fieldIds[i];
                                if (!item[fieldId]) continue;
                                source +=
                                    '<div class="info-line"><strong>' +
                                    fieldParameters[fieldId].title +
                                    ":</strong>" +
                                    item[fieldId] +
                                    "</div>";
                            }
                        } else {
                            if (item.phoneWork)
                                source +=
                                    '<div class="info-line"><strong>\u0420\u0430\u0431\u043E\u0447\u0438\u0439 \u0442\u0435\u043B\u0435\u0444\u043E\u043D:</strong>' +
                                    item.phoneWork +
                                    "</div>";
                            if (item.phone)
                                source +=
                                    '<div class="info-line"><strong>\u0422\u0435\u043B\u0435\u0444\u043E\u043D:</strong>' +
                                    item.phone +
                                    "</div>";
                            if (item.email)
                                source +=
                                    '<div class="info-line"><strong>Email:</strong>' +
                                    item.email +
                                    "</div>";
                        }
                        return source;
                    }

                    function genDepartmentStructure() {
                        var item =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};
                        var childType =
                            arguments.length > 1 && arguments[1] !== undefined
                                ? arguments[1]
                                : false;

                        var source = "";
                        for (var i in item.submissive) {
                            var structureItem = item.submissive[i];
                            if (!structureItem) continue;
                            if (childType) if (structureItem.type !== childType) continue;
                            source +=
                                '<div class="structure-item"><h3>' +
                                structureItem.name +
                                "</h3>";
                            if (structureItem.submissive && structureItem.submissive[0]) {
                                var structureManager = structureItem.submissive[0];
                                source +=
                                    '<div class="info"><hr><div class="role">' +
                                    structureManager.roleTitle +
                                    '</div>\n                    <div class="name">' +
                                    structureManager.name +
                                    "</div></div>";
                            }
                            source += "</div>";
                        }
                        return source;
                    }

                    function genDivisionStructure() {
                        var item =
                            arguments.length > 0 && arguments[0] !== undefined
                                ? arguments[0]
                                : {};
                        var childType =
                            arguments.length > 1 && arguments[1] !== undefined
                                ? arguments[1]
                                : false;

                        var source = "";
                        if (item.submissive && item.submissive.length > 0) {
                            source +=
                                '<div class="structure-header"><div>ФИО</div><div>Рабочий телефон</div><div>Телефон</div><div>Email</div></div>';
                            for (var i in item.submissive) {
                                var positionItem = item.submissive[i];
                                if (!positionItem) continue;
                                if (childType) if (positionItem.type !== childType) continue;
                                source += '<div class="division-position">';
                                source +=
                                    "<div>" +
                                    (positionItem.name ? positionItem.name : "") +
                                    "<br><span>" +
                                    positionItem.roleTitle +
                                    "</span></div>";
                                source +=
                                    "<div>" +
                                    (positionItem.phoneWork ? positionItem.phoneWork : "") +
                                    "</div>";
                                source +=
                                    "<div>" +
                                    (positionItem.phone ? positionItem.phone : "") +
                                    "</div>";
                                source +=
                                    "<div>" +
                                    (positionItem.email ? positionItem.email : "") +
                                    "</div>";
                                source += "</div>";
                            }
                        }
                        return source;
                    }

                    return source;
                }
            }
        ],
        [
            {
                key: "closeModals",
                value: function closeModals() {
                    document
                        .querySelectorAll("[data-structure-modal]")
                        .forEach(function(modal) {
                            modal.parentNode.removeChild(modal);
                        });
                }
            },
            {
                key: "calculatePathPositionHandler",
                value: function calculatePathPositionHandler(event) {
                    var pathNode = false;
                    if (this.dataset.structurePathParentItem) {
                        pathNode = this;
                    } else {
                        pathNode = document.querySelector(
                            '[data-structure-path="' + this.dataset.pathScrollEvent + '"]'
                        );
                    }
                    var itemId = pathNode.dataset.structurePathParentItem;
                    if (!itemId) return Structure._removeActiveItemPath(itemId);
                    var itemNode = document.querySelector(
                        '[data-structure-item="' + itemId + '"]'
                    );
                    if (!itemNode) return Structure._removeActiveItemPath(itemId);
                    var targetLevelId =
                        parseInt(itemNode.parentNode.dataset.structureLevel) + 1;
                    if (!targetLevelId || isNaN(targetLevelId))
                        return Structure._removeActiveItemPath(itemId);
                    var targetLevelNode = document.querySelector(
                        '[data-structure-level="' + targetLevelId + '"]'
                    );
                    if (!targetLevelNode) return Structure._removeActiveItemPath(itemId);
                    var targetNode = targetLevelNode.querySelector(
                        ".active[data-structure-item]"
                    );
                    if (!targetNode)
                        targetNode = targetLevelNode.querySelector("[data-structure-item]");
                    if (!targetNode) return Structure._removeActiveItemPath(itemId);
                    if (targetNode.classList.contains("assistant")) {
                        var iterateNode = targetNode;
                        var parentNode = false;
                        while ((iterateNode = iterateNode.previousElementSibling)) {
                            if (!iterateNode.classList.contains("assistant")) {
                                parentNode = iterateNode;
                                break;
                            }
                        }
                        if (!parentNode) return Structure._removeActiveItemPath(itemId);
                        targetNode = parentNode;
                    }
                    // let levelNode = itemNode.parentNode;
                    var position = {
                        offsetTop: targetNode.parentNode.parentNode.offsetTop,
                        offsetLeft:
                        itemNode.offsetLeft - itemNode.parentNode.scrollLeft + 150
                    };
                    pathNode.style.opacity = 1;
                    if (
                        targetNode.classList.contains("partner") ||
                        targetNode.classList.contains("active")
                    ) {
                        position.targetLeft =
                            targetNode.offsetLeft - targetNode.parentNode.scrollLeft + 150;
                    } else {
                        var levelItems = targetLevelNode.querySelectorAll(
                            "[data-structure-item]"
                        );
                        if (levelItems.length > 1) {
                            var leftLevelItemOffset =
                                levelItems[0].offsetLeft -
                                levelItems[0].parentNode.scrollLeft +
                                150;
                            var rightLevelItemOffset =
                                levelItems[levelItems.length - 1].offsetLeft -
                                levelItems[levelItems.length - 1].parentNode.scrollLeft +
                                150;
                            if (
                                position.offsetLeft >= leftLevelItemOffset &&
                                position.offsetLeft <= rightLevelItemOffset
                            ) {
                                pathNode.style.opacity = 0;
                            } else if (position.offsetLeft < leftLevelItemOffset) {
                                position.targetLeft = leftLevelItemOffset;
                            } else {
                                position.targetLeft = rightLevelItemOffset;
                            }
                        } else position.targetLeft = document.body.clientWidth / 2;
                    }
                    position.pathLeft =
                        position.offsetLeft > position.targetLeft
                            ? position.targetLeft
                            : position.offsetLeft;
                    position.pathWidth =
                        position.offsetLeft > position.targetLeft
                            ? position.offsetLeft - position.targetLeft
                            : position.targetLeft - position.offsetLeft;
                    if (position.pathWidth > 0) {
                        if (position.offsetLeft > position.targetLeft) {
                            position.pathLeft += 0;
                            position.pathWidth += 2;
                        } else {
                            position.pathLeft -= 1;
                            position.pathWidth += 4;
                        }
                    }
                    pathNode.style.top = position.offsetTop + "px";
                    pathNode.style.left = position.pathLeft + "px";
                    pathNode.style.width = position.pathWidth + "px";
                }
            },
            {
                key: "calculateSubPathPositionHandler",
                value: function calculateSubPathPositionHandler(event) {
                    var pathNode = document.querySelector(
                        '[data-structure-sub-path="' +
                        this.dataset.subPathScrollEvent +
                        '"]'
                    );
                    var itemId = pathNode.dataset.structurePathTargetItem;
                    if (!itemId) return;
                    var itemNode = document.querySelector(
                        '[data-structure-item="' + itemId + '"]'
                    );
                    if (!itemNode) return;
                    var targetLevelId = parseInt(
                        itemNode.parentNode.dataset.structureLevel
                    );
                    if (!targetLevelId || isNaN(targetLevelId)) return;
                    var targetLevelNode = document.querySelector(
                        '[data-structure-level="' + targetLevelId + '"]'
                    );
                    if (!targetLevelNode) return;
                    var targetNode = targetLevelNode.querySelector(
                        "[data-structure-item]"
                    );
                    if (!targetNode) return;

                    var position = {
                        offsetTop: targetNode.offsetTop - 72,
                        offsetLeft:
                        itemNode.offsetLeft - itemNode.parentNode.scrollLeft + 150
                    };
                    if (
                        targetNode.classList.contains("partner") ||
                        targetNode.classList.contains("active")
                    ) {
                        position.targetLeft =
                            targetNode.offsetLeft - targetNode.parentNode.scrollLeft + 150;
                        //else position.targetLeft = document.body.clientWidth / 2;
                        position.pathLeft =
                            position.offsetLeft > position.targetLeft
                                ? position.targetLeft
                                : position.offsetLeft;
                        position.pathWidth =
                            position.offsetLeft > position.targetLeft
                                ? position.offsetLeft - position.targetLeft
                                : position.targetLeft - position.offsetLeft;
                    }
                    pathNode.style.top = position.offsetTop + "px";
                    pathNode.style.left = position.pathLeft + "px";
                    pathNode.style.width = position.pathWidth + "px";
                }
            },
            {
                key: "calculateLevelScrollButtons",
                value: function calculateLevelScrollButtons() {}
            },
            {
                key: "updateActiveItemPathes",
                value: function updateActiveItemPathes() {
                    document
                        .querySelectorAll("[data-structure-path]")
                        .forEach(function(path) {
                            Structure.calculatePathPositionHandler.call(path);
                        });
                    document
                        .querySelectorAll("[data-structure-sub-path]")
                        .forEach(function(path) {
                            Structure.calculateSubPathPositionHandler.call(path);
                        });

                    document
                        .querySelectorAll("[data-structure-level]")
                        .forEach(function(levelNode) {
                            if (levelNode.scrollWidth > document.body.clientWidth) {
                                if (levelNode.scrollLeft < 100)
                                    Structure._levelScrollButton(levelNode, "left", false);
                                else Structure._levelScrollButton(levelNode, "left", true);
                                if (
                                    levelNode.scrollWidth -
                                    levelNode.scrollLeft -
                                    document.body.clientWidth <
                                    100
                                )
                                    Structure._levelScrollButton(levelNode, "right", false);
                                else Structure._levelScrollButton(levelNode, "right", true);
                            } else {
                                Structure._levelScrollButton(levelNode, "left", false);
                                Structure._levelScrollButton(levelNode, "right", false);
                            }
                        });
                }
            },
            {
                key: "_levelScrollButton",
                value: function _levelScrollButton(levelNode, side) {
                    var state =
                        arguments.length > 2 && arguments[2] !== undefined
                            ? arguments[2]
                            : true;

                    switch (side) {
                        case "left":
                            levelNode.parentNode.querySelector(
                                ".structure-scroll-left"
                            ).style.display = state ? "block" : "none";
                            break;
                        case "right":
                            levelNode.parentNode.querySelector(
                                ".structure-scroll-right"
                            ).style.display = state ? "block" : "none";
                            break;
                    }
                }
            },
            {
                key: "_removeActiveItemPath",
                value: function _removeActiveItemPath(level) {
                    Structure._pathesWrapperNode
                        .querySelectorAll('[data-structure-path="' + level + '"]')
                        .forEach(function(pathNode) {
                            pathNode.parentNode.removeChild(pathNode);
                        });
                }
            }
        ]
    );

    return Structure;
})();

